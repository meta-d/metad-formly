import{Emitter}from"../../base/common/event.js";import{toDisposable}from"../../base/common/lifecycle.js";import{shouldSynchronizeModel}from"./model.js";import{score}from"./languageSelector.js";function isExclusive(selector){return"string"!=typeof selector&&(Array.isArray(selector)?selector.every(isExclusive):!!selector.exclusive)}export class LanguageFeatureRegistry{constructor(_notebookTypeResolver){this._notebookTypeResolver=_notebookTypeResolver,this._clock=0,this._entries=[],this._onDidChange=new Emitter,this.onDidChange=this._onDidChange.event}register(selector,provider){let entry={selector,provider,_score:-1,_time:this._clock++};return this._entries.push(entry),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),toDisposable((()=>{if(entry){const idx=this._entries.indexOf(entry);idx>=0&&(this._entries.splice(idx,1),this._lastCandidate=void 0,this._onDidChange.fire(this._entries.length),entry=void 0)}}))}has(model){return this.all(model).length>0}all(model){if(!model)return[];this._updateScores(model);const result=[];for(let entry of this._entries)entry._score>0&&result.push(entry.provider);return result}ordered(model){const result=[];return this._orderedForEach(model,(entry=>result.push(entry.provider))),result}orderedGroups(model){const result=[];let lastBucket,lastBucketScore;return this._orderedForEach(model,(entry=>{lastBucket&&lastBucketScore===entry._score?lastBucket.push(entry.provider):(lastBucketScore=entry._score,lastBucket=[entry.provider],result.push(lastBucket))})),result}_orderedForEach(model,callback){if(model){this._updateScores(model);for(const entry of this._entries)entry._score>0&&callback(entry)}}_updateScores(model){var _a;const notebookType=null===(_a=this._notebookTypeResolver)||void 0===_a?void 0:_a.call(this,model.uri),candidate={uri:model.uri.toString(),language:model.getLanguageId(),notebookType};if(!this._lastCandidate||this._lastCandidate.language!==candidate.language||this._lastCandidate.uri!==candidate.uri||this._lastCandidate.notebookType!==candidate.notebookType){this._lastCandidate=candidate;for(let entry of this._entries)if(entry._score=score(entry.selector,model.uri,model.getLanguageId(),shouldSynchronizeModel(model),notebookType),isExclusive(entry.selector)&&entry._score>0){for(let entry of this._entries)entry._score=0;entry._score=1e3;break}this._entries.sort(LanguageFeatureRegistry._compareByScoreAndTime)}}static _compareByScoreAndTime(a,b){return a._score<b._score?1:a._score>b._score?-1:a._time<b._time?1:a._time>b._time?-1:0}}