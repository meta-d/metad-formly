import{LcsDiff}from"../../../../base/common/diff/diff.js";import*as strings from"../../../../base/common/strings.js";import{Range}from"../../../common/core/range.js";import{GhostText,GhostTextPart}from"./ghostText.js";export function normalizedInlineCompletionsEquals(a,b){return a===b||!(!a||!b)&&(a.range.equalsRange(b.range)&&a.text===b.text&&a.command===b.command)}export function inlineCompletionToGhostText(inlineCompletion,textModel,mode,cursorPosition,previewSuffixLength=0){if(inlineCompletion.range.startLineNumber!==inlineCompletion.range.endLineNumber)return;const sourceLine=textModel.getLineContent(inlineCompletion.range.startLineNumber),sourceIndentationLength=strings.getLeadingWhitespace(sourceLine).length;if(inlineCompletion.range.startColumn-1<=sourceIndentationLength){const suggestionAddedIndentationLength=strings.getLeadingWhitespace(inlineCompletion.text).length,replacedIndentation=sourceLine.substring(inlineCompletion.range.startColumn-1,sourceIndentationLength),rangeThatDoesNotReplaceIndentation=Range.fromPositions(inlineCompletion.range.getStartPosition().delta(0,replacedIndentation.length),inlineCompletion.range.getEndPosition()),suggestionWithoutIndentationChange=inlineCompletion.text.startsWith(replacedIndentation)?inlineCompletion.text.substring(replacedIndentation.length):inlineCompletion.text.substring(suggestionAddedIndentationLength);inlineCompletion={range:rangeThatDoesNotReplaceIndentation,text:suggestionWithoutIndentationChange,command:inlineCompletion.command}}const valueToBeReplaced=textModel.getValueInRange(inlineCompletion.range),changes=cachingDiff(valueToBeReplaced,inlineCompletion.text);if(!changes)return;const lineNumber=inlineCompletion.range.startLineNumber,parts=new Array;if("prefix"===mode){const filteredChanges=changes.filter((c=>0===c.originalLength));if(filteredChanges.length>1||1===filteredChanges.length&&filteredChanges[0].originalStart!==valueToBeReplaced.length)return}const previewStartInCompletionText=inlineCompletion.text.length-previewSuffixLength;for(const c of changes){const insertColumn=inlineCompletion.range.startColumn+c.originalStart+c.originalLength;if("subwordSmart"===mode&&cursorPosition&&cursorPosition.lineNumber===inlineCompletion.range.startLineNumber&&insertColumn<cursorPosition.column)return;if(c.originalLength>0)return;if(0===c.modifiedLength)continue;const modifiedEnd=c.modifiedStart+c.modifiedLength,nonPreviewTextEnd=Math.max(c.modifiedStart,Math.min(modifiedEnd,previewStartInCompletionText)),nonPreviewText=inlineCompletion.text.substring(c.modifiedStart,nonPreviewTextEnd),italicText=inlineCompletion.text.substring(nonPreviewTextEnd,Math.max(c.modifiedStart,modifiedEnd));if(nonPreviewText.length>0){const lines=strings.splitLines(nonPreviewText);parts.push(new GhostTextPart(insertColumn,lines,!1))}if(italicText.length>0){const lines=strings.splitLines(italicText);parts.push(new GhostTextPart(insertColumn,lines,!0))}}return new GhostText(lineNumber,parts,0)}let lastRequest;function cachingDiff(originalValue,newValue){if((null==lastRequest?void 0:lastRequest.originalValue)===originalValue&&(null==lastRequest?void 0:lastRequest.newValue)===newValue)return null==lastRequest?void 0:lastRequest.changes;{const changes=smartDiff(originalValue,newValue);return lastRequest={originalValue,newValue,changes},changes}}function smartDiff(originalValue,newValue){if(originalValue.length>5e3||newValue.length>5e3)return;function getMaxCharCode(val){let maxCharCode=0;for(let i=0,len=val.length;i<len;i++){const charCode=val.charCodeAt(i);charCode>maxCharCode&&(maxCharCode=charCode)}return maxCharCode}const maxCharCode=Math.max(getMaxCharCode(originalValue),getMaxCharCode(newValue));function getUniqueCharCode(id){if(id<0)throw new Error("unexpected");return maxCharCode+id+1}function getElements(source){let level=0,group=0;const characters=new Int32Array(source.length);for(let i=0,len=source.length;i<len;i++){const id=100*group+level;"("===source[i]?(characters[i]=getUniqueCharCode(2*id),level++):")"===source[i]?(characters[i]=getUniqueCharCode(2*id+1),1===level&&group++,level=Math.max(level-1,0)):characters[i]=source.charCodeAt(i)}return characters}const elements1=getElements(originalValue),elements2=getElements(newValue);return new LcsDiff({getElements:()=>elements1},{getElements:()=>elements2}).ComputeDiff(!1).changes}