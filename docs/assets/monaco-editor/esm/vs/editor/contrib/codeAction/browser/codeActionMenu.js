var __decorate=this&&this.__decorate||function(decorators,target,key,desc){var d,c=arguments.length,r=c<3?target:null===desc?desc=Object.getOwnPropertyDescriptor(target,key):desc;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)r=Reflect.decorate(decorators,target,key,desc);else for(var i=decorators.length-1;i>=0;i--)(d=decorators[i])&&(r=(c<3?d(r):c>3?d(target,key,r):d(target,key))||r);return c>3&&r&&Object.defineProperty(target,key,r),r},__param=this&&this.__param||function(paramIndex,decorator){return function(target,key){decorator(target,key,paramIndex)}},__awaiter=this&&this.__awaiter||function(thisArg,_arguments,P,generator){return new(P||(P=Promise))((function(resolve,reject){function fulfilled(value){try{step(generator.next(value))}catch(e){reject(e)}}function rejected(value){try{step(generator.throw(value))}catch(e){reject(e)}}function step(result){result.done?resolve(result.value):function adopt(value){return value instanceof P?value:new P((function(resolve){resolve(value)}))}(result.value).then(fulfilled,rejected)}step((generator=generator.apply(thisArg,_arguments||[])).next())}))};import{getDomNodePagePosition}from"../../../../base/browser/dom.js";import{Action,Separator}from"../../../../base/common/actions.js";import{canceled}from"../../../../base/common/errors.js";import{Lazy}from"../../../../base/common/lazy.js";import{Disposable,MutableDisposable}from"../../../../base/common/lifecycle.js";import{Position}from"../../../common/core/position.js";import{ILanguageFeaturesService}from"../../../common/services/languageFeatures.js";import{codeActionCommandId,CodeActionItem,fixAllCommandId,organizeImportsCommandId,refactorCommandId,sourceActionCommandId}from"./codeAction.js";import{CodeActionCommandArgs,CodeActionKind}from"./types.js";import{IContextMenuService}from"../../../../platform/contextview/browser/contextView.js";import{IKeybindingService}from"../../../../platform/keybinding/common/keybinding.js";class CodeActionAction extends Action{constructor(action,callback){super(action.command?action.command.id:action.title,stripNewlines(action.title),void 0,!action.disabled,callback),this.action=action}}function stripNewlines(str){return str.replace(/\r\n|\r|\n/g," ")}let CodeActionMenu=class CodeActionMenu extends Disposable{constructor(_editor,_delegate,_contextMenuService,keybindingService,_languageFeaturesService){super(),this._editor=_editor,this._delegate=_delegate,this._contextMenuService=_contextMenuService,this._languageFeaturesService=_languageFeaturesService,this._visible=!1,this._showingActions=this._register(new MutableDisposable),this._keybindingResolver=new CodeActionKeybindingResolver({getKeybindings:()=>keybindingService.getKeybindings()})}get isVisible(){return this._visible}show(trigger,codeActions,at,options){return __awaiter(this,void 0,void 0,(function*(){const actionsToShow=options.includeDisabledActions?codeActions.allActions:codeActions.validActions;if(!actionsToShow.length)return void(this._visible=!1);if(!this._editor.getDomNode())throw this._visible=!1,canceled();this._visible=!0,this._showingActions.value=codeActions;const menuActions=this.getMenuActions(trigger,actionsToShow,codeActions.documentation),anchor=Position.isIPosition(at)?this._toCoords(at):at||{x:0,y:0},resolver=this._keybindingResolver.getResolver(),useShadowDOM=this._editor.getOption(115);this._contextMenuService.showContextMenu({domForShadowRoot:useShadowDOM?this._editor.getDomNode():void 0,getAnchor:()=>anchor,getActions:()=>menuActions,onHide:()=>{this._visible=!1,this._editor.focus()},autoSelectFirstItem:!0,getKeyBinding:action=>action instanceof CodeActionAction?resolver(action.action):void 0})}))}getMenuActions(trigger,actionsToShow,documentation){var _a,_b;const toCodeActionAction=item=>new CodeActionAction(item.action,(()=>this._delegate.onSelectCodeAction(item))),result=actionsToShow.map(toCodeActionAction),allDocumentation=[...documentation],model=this._editor.getModel();if(model&&result.length)for(const provider of this._languageFeaturesService.codeActionProvider.all(model))provider._getAdditionalMenuItems&&allDocumentation.push(...provider._getAdditionalMenuItems({trigger:trigger.type,only:null===(_b=null===(_a=trigger.filter)||void 0===_a?void 0:_a.include)||void 0===_b?void 0:_b.value},actionsToShow.map((item=>item.action))));return allDocumentation.length&&result.push(new Separator,...allDocumentation.map((command=>toCodeActionAction(new CodeActionItem({title:command.title,command},void 0))))),result}_toCoords(position){if(!this._editor.hasModel())return{x:0,y:0};this._editor.revealPosition(position,1),this._editor.render();const cursorCoords=this._editor.getScrolledVisiblePosition(position),editorCoords=getDomNodePagePosition(this._editor.getDomNode());return{x:editorCoords.left+cursorCoords.left,y:editorCoords.top+cursorCoords.top+cursorCoords.height}}};CodeActionMenu=__decorate([__param(2,IContextMenuService),__param(3,IKeybindingService),__param(4,ILanguageFeaturesService)],CodeActionMenu);export{CodeActionMenu};export class CodeActionKeybindingResolver{constructor(_keybindingProvider){this._keybindingProvider=_keybindingProvider}getResolver(){const allCodeActionBindings=new Lazy((()=>this._keybindingProvider.getKeybindings().filter((item=>CodeActionKeybindingResolver.codeActionCommands.indexOf(item.command)>=0)).filter((item=>item.resolvedKeybinding)).map((item=>{let commandArgs=item.commandArgs;return item.command===organizeImportsCommandId?commandArgs={kind:CodeActionKind.SourceOrganizeImports.value}:item.command===fixAllCommandId&&(commandArgs={kind:CodeActionKind.SourceFixAll.value}),Object.assign({resolvedKeybinding:item.resolvedKeybinding},CodeActionCommandArgs.fromUser(commandArgs,{kind:CodeActionKind.None,apply:"never"}))}))));return action=>{if(action.kind){const binding=this.bestKeybindingForCodeAction(action,allCodeActionBindings.getValue());return null==binding?void 0:binding.resolvedKeybinding}}}bestKeybindingForCodeAction(action,candidates){if(!action.kind)return;const kind=new CodeActionKind(action.kind);return candidates.filter((candidate=>candidate.kind.contains(kind))).filter((candidate=>!candidate.preferred||action.isPreferred)).reduceRight(((currentBest,candidate)=>currentBest?currentBest.kind.contains(candidate.kind)?candidate:currentBest:candidate),void 0)}}CodeActionKeybindingResolver.codeActionCommands=[refactorCommandId,codeActionCommandId,sourceActionCommandId,organizeImportsCommandId,fixAllCommandId];